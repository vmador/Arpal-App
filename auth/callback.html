
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autenticando - Arpal</title>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            background-color: #000000; 
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .container {
            max-width: 400px;
            padding: 40px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top: 3px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #ef4444;
            margin-top: 20px;
        }
        .success {
            color: #10b981;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        <h2 id="status">Processing authentication...</h2>
        <p id="message">Please wait while we complete your authentication.</p>
        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script>
        async function handleAuthCallback() {
            const statusEl = document.getElementById('status')
            const messageEl = document.getElementById('message')
            const errorEl = document.getElementById('error')
            const spinnerEl = document.getElementById('spinner')

            try {
                console.log('🔄 Processing OAuth callback in PWA')
                console.log('URL:', window.location.href)
                console.log('Hash:', window.location.hash)
                console.log('Search:', window.location.search)

                // Detect if popup
                const isPopup = window.opener !== null
                console.log('Is popup:', isPopup)

                // Extract tokens from hash and search
                const hash = window.location.hash.substring(1)
                const search = window.location.search.substring(1)

                const hashParams = new URLSearchParams(hash)
                const searchParams = new URLSearchParams(search)

                // More robust token extraction
                let accessToken = hashParams.get('access_token') || 
                                searchParams.get('access_token') ||
                                hashParams.get('access-token') ||
                                searchParams.get('access-token')

                let refreshToken = hashParams.get('refresh_token') || 
                                searchParams.get('refresh_token') ||
                                hashParams.get('refresh-token') ||
                                searchParams.get('refresh-token')

                let error = hashParams.get('error') || searchParams.get('error')
                let errorDescription = hashParams.get('error_description') || 
                                    searchParams.get('error_description')

                // Manual parsing fallback
                if (!accessToken && hash) {
                    const tokenMatch = hash.match(/access_token=([^&]+)/)
                    if (tokenMatch) {
                        accessToken = decodeURIComponent(tokenMatch[1])
                    }
                }

                if (!refreshToken && hash) {
                    const refreshMatch = hash.match(/refresh_token=([^&]+)/)
                    if (refreshMatch) {
                        refreshToken = decodeURIComponent(refreshMatch[1])
                    }
                }

                console.log('Extracted tokens:', {
                    hasAccessToken: !!accessToken,
                    hasRefreshToken: !!refreshToken,
                    error,
                    errorDescription
                })

                if (error) {
                    throw new Error(errorDescription || error)
                }

                if (!accessToken) {
                    throw new Error('No access token received')
                }

                // SUCCESS
                spinnerEl.style.display = 'none'
                statusEl.textContent = 'Authentication successful!'
                statusEl.className = 'success'
                messageEl.textContent = 'Transferring session...'

                // Prepare token data
                const tokenData = {
                    access_token: accessToken,
                    refresh_token: refreshToken,
                    expires_at: hashParams.get('expires_at') || searchParams.get('expires_at'),
                    expires_in: hashParams.get('expires_in') || searchParams.get('expires_in'),
                    provider_token: hashParams.get('provider_token') || searchParams.get('provider_token'),
                    token_type: hashParams.get('token_type') || searchParams.get('token_type') || 'bearer'
                }

                if (isPopup) {
                    // POPUP CASE: Send tokens to opener
                    console.log('📤 Sending tokens to opener (popup)')
                    
                    const messageData = {
                        type: 'SUPABASE_AUTH_SUCCESS',
                        tokens: tokenData
                    }

                    if (window.opener) {
                        // Send to multiple origins to ensure delivery
                        window.opener.postMessage(messageData, '*')
                        window.opener.postMessage(messageData, 'https://arpaldsn.com')
                        window.opener.postMessage(messageData, 'https://arpalapp.framer.website')
                        
                        console.log('📤 Tokens sent successfully')
                        messageEl.textContent = 'Tokens sent successfully. Closing window...'

                        setTimeout(() => {
                            console.log('🔚 Closing popup window')
                            window.close()
                        }, 2000)
                    } else {
                        console.warn('⚠️ window.opener not found')
                        messageEl.textContent = 'Main window not found. Please close this window manually.'
                    }
                } else {
                    // REDIRECT CASE: Save to localStorage and redirect
                    console.log('🔄 Redirect case: saving session and redirecting')
                    
                    // Save session data for PWA
                    const sessionInfo = {
                        tokens: tokenData,
                        authenticated: true,
                        timestamp: Date.now()
                    }

                    localStorage.setItem('arpal_session_data', JSON.stringify(sessionInfo))
                    
                    messageEl.textContent = 'Session saved! Redirecting to application...'

                    setTimeout(() => {
                        window.location.href = '/'
                    }, 2000)
                }

            } catch (error) {
                console.error('❌ Error in OAuth callback:', error)
                
                spinnerEl.style.display = 'none'
                statusEl.textContent = 'Authentication error'
                statusEl.className = 'error'
                messageEl.textContent = ''
                errorEl.textContent = error.message
                errorEl.style.display = 'block'

                const isPopup = window.opener !== null

                if (isPopup && window.opener) {
                    // Send error to opener
                    const errorMessage = {
                        type: 'SUPABASE_AUTH_ERROR',
                        error: error.message
                    }

                    window.opener.postMessage(errorMessage, '*')
                    window.opener.postMessage(errorMessage, 'https://arpaldsn.com')

                    setTimeout(() => {
                        console.log('🔚 Closing popup window (error)')
                        window.close()
                    }, 3000)
                } else {
                    // Redirect to home after error
                    setTimeout(() => {
                        window.location.href = '/'
                    }, 5000)
                }
            }
        }

        // Execute callback handler
        handleAuthCallback()
    </script>
</body>
</html>
