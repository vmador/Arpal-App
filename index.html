<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Arpal Soundscapes</title>
  <meta name="description" content="Soundscapes and Meditations">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512x512.png">
  <link rel="apple-touch-icon" href="/icon-192x192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="arpal">
  <meta property="og:title" content="arpal">
  <meta property="og:description" content="Soundscapes and Meditations">
  <meta property="og:image" content="/social-preview.png">
  <meta property="og:url" content="https://arpaldsn.com/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="arpal">
  <meta name="twitter:description" content="Soundscapes and Meditations">
  <meta name="twitter:image" content="/social-preview.png">

  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: #000000;
    }
    iframe {
      width: 100lvw;
      height: 100lvh;
      border: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    @supports(padding: max(0px)) {
      body, iframe {
        padding-top: env(safe-area-inset-top);
        height: calc(100lvh - env(safe-area-inset-top));
      }
    }
  </style>
</head>
<body>
  <iframe 
    id="framerContent" 
    src="https://arpalapp.framer.website" 
    allowfullscreen 
    allow="geolocation; camera; microphone; storage-access"
    sandbox="allow-same-origin allow-scripts allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox"
  ></iframe>

  <script>
    (function() {
      const SESSION_KEY = 'arpal_session_data';
      const iframe = document.getElementById('framerContent');
      const targetOrigin = 'https://arpalapp.framer.website';

      // Variables para manejo de OAuth popup
      let activeOAuthPopup = null;
      let oauthMessageListener = null;

      function sendMessageToIframe(message) {
        if (iframe && iframe.contentWindow) {
          console.log('Sending message to iframe:', message.type);
          iframe.contentWindow.postMessage(message, targetOrigin);
        } else {
          console.error('No se pudo enviar mensaje al iframe');
        }
      }

      // Función para manejar popup OAuth
      function handleOAuthPopup(popupUrl, popupOptions) {
        console.log('PWA: Abriendo popup OAuth:', popupUrl);
        
        // Cerrar popup anterior si existe
        if (activeOAuthPopup && !activeOAuthPopup.closed) {
          activeOAuthPopup.close();
        }
        
        // Abrir nuevo popup
        activeOAuthPopup = window.open(popupUrl, 'oauth-popup', popupOptions);
        
        if (!activeOAuthPopup) {
          console.error('PWA: No se pudo abrir popup, usando redirect');
          
          // Notificar al iframe que el popup falló
          sendMessageToIframe({
            type: 'OAUTH_POPUP_FAILED',
            fallbackUrl: popupUrl
          });
          return;
        }
        
        // Cleanup función anterior si existe
        if (oauthMessageListener) {
          window.removeEventListener('message', oauthMessageListener);
        }
        
        // Nueva función para escuchar mensajes del popup
        oauthMessageListener = (event) => {
          console.log('PWA: Mensaje recibido de popup:', event.origin, event.data);
          
          // Verificar origen del callback
          const allowedCallbackOrigins = [
            'https://arpaldsn.com',
            'https://arpalapp.framer.website'
          ];
          
          const isValidCallbackOrigin = allowedCallbackOrigins.some(origin => 
            event.origin === origin || 
            event.origin.includes('arpaldsn.com') ||
            event.origin.includes('framer.website')
          );
          
          if (!isValidCallbackOrigin) {
            console.log('PWA: Origen de callback no válido:', event.origin);
            return;
          }
          
          // Filtrar solo mensajes de OAuth
          if (event.data && (
            event.data.type === 'SUPABASE_AUTH_SUCCESS' ||
            event.data.type === 'SUPABASE_AUTH_ERROR'
          )) {
            console.log('PWA: Reenviando mensaje OAuth a iframe:', event.data);
            
            // Reenviar mensaje al iframe de Framer
            sendMessageToIframe(event.data);
            
            // Cleanup
            window.removeEventListener('message', oauthMessageListener);
            oauthMessageListener = null;
            
            if (activeOAuthPopup && !activeOAuthPopup.closed) {
              activeOAuthPopup.close();
            }
            activeOAuthPopup = null;
          }
        };
        
        window.addEventListener('message', oauthMessageListener);
        
        // Monitor cierre de popup
        const checkClosed = setInterval(() => {
          if (activeOAuthPopup.closed) {
            clearInterval(checkClosed);
            console.log('PWA: Popup OAuth cerrado');
            
            if (oauthMessageListener) {
              window.removeEventListener('message', oauthMessageListener);
              oauthMessageListener = null;
            }
            
            // Notificar al iframe que el popup se cerró sin completar auth
            sendMessageToIframe({
              type: 'OAUTH_POPUP_CLOSED'
            });
            
            activeOAuthPopup = null;
          }
        }, 1000);
        
        // Timeout de seguridad (5 minutos)
        setTimeout(() => {
          if (activeOAuthPopup && !activeOAuthPopup.closed) {
            console.log('PWA: Timeout de OAuth popup alcanzado');
            activeOAuthPopup.close();
            
            sendMessageToIframe({
              type: 'OAUTH_POPUP_TIMEOUT'
            });
          }
        }, 300000);
      }

      window.addEventListener('message', function(event) {
        if (event.origin !== targetOrigin) {
          console.log('Message from unexpected origin:', event.origin);
          return;
        }
        
        try {
          if (event.data && event.data.type) {
            console.log('Received message from iframe:', event.data.type);
            
            switch(event.data.type) {
              case 'setSessionData':
                if (event.data.sessionData) {
                  localStorage.setItem(SESSION_KEY, JSON.stringify(event.data.sessionData));
                  sessionStorage.setItem(SESSION_KEY, JSON.stringify(event.data.sessionData));
                } else {
                  localStorage.removeItem(SESSION_KEY);
                  sessionStorage.removeItem(SESSION_KEY);
                }
                break;
                
              case 'getSessionData':
                const sessionData = localStorage.getItem(SESSION_KEY);
                sendMessageToIframe({
                  type: 'sessionDataResponse',
                  sessionData: sessionData ? JSON.parse(sessionData) : null
                });
                break;
                
              // CASO ESPECÍFICO PARA OAUTH POPUP
              case 'OPEN_OAUTH_POPUP':
                console.log('PWA: Solicitud de popup OAuth recibida');
                if (event.data.url && event.data.options) {
                  handleOAuthPopup(event.data.url, event.data.options);
                } else {
                  console.error('PWA: Datos incompletos para popup OAuth');
                }
                break;

              // CASO PARA REDIRECT OAUTH
              case 'OAUTH_REDIRECT':
                console.log('PWA: Redirect OAuth recibido:', event.data.url);
                if (event.data.url) {
                  window.location.href = event.data.url;
                } else {
                  console.error('PWA: URL de redirect no proporcionada');
                }
                break;

              // CASO GENÉRICO PARA POPUPS (mantener compatibilidad)
              case 'openPopup':
                if (event.data.url) {
                  window.open(event.data.url, "_blank", "width=600,height=700");
                }
                break;

              // CASOS LEGACY DE SESIÓN (mantener compatibilidad)
              case 'sessionData':
                // Legacy support para apps que usen el formato anterior
                localStorage.setItem('sessionData', JSON.stringify(event.data.sessionData));
                break;

              default:
                console.log('Unhandled message type:', event.data.type);
                break;
            }
          }
        } catch (error) {
          console.error('PWA: Error processing message:', error);
        }
      });

      function restoreSession() {
        try {
          // Intentar con el nuevo formato primero
          let sessionData = localStorage.getItem(SESSION_KEY);
          
          // Fallback al formato legacy
          if (!sessionData) {
            sessionData = localStorage.getItem('sessionData');
          }
          
          if (sessionData) {
            setTimeout(() => {
              sendMessageToIframe({
                type: 'restoreSession',
                sessionData: JSON.parse(sessionData)
              });
            }, 2000);
          }
        } catch (error) {
          console.error('PWA: Error restoring session:', error);
        }
      }

      // Manejar visibilidad para restaurar sesión
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
          restoreSession();
        }
      });

      // Cuando el iframe carga
      iframe.onload = function() { 
        console.log('Iframe loaded');
        restoreSession(); 
      };

      // Service Worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/service-worker.js')
            .then(function(registration) {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(function(err) {
              console.error('ServiceWorker registration failed: ', err);
            });
        });
      }

      // Log de depuración
      console.log('Arpal PWA Script initialized');
      console.log('Target iframe origin:', targetOrigin);
      console.log('Session key:', SESSION_KEY);
      
      // Verificar estado cada 3 segundos durante los primeros 15 segundos
      let checkCount = 0;
      const statusChecker = setInterval(() => {
        checkCount++;
        console.log(`[${checkCount}] PWA status:`, {
          iframe: !!iframe,
          sessionData: !!localStorage.getItem(SESSION_KEY),
          activeOAuthPopup: !!activeOAuthPopup,
          oauthListener: !!oauthMessageListener
        });
        
        if (checkCount >= 5) {
          clearInterval(statusChecker);
        }
      }, 3000);
      
    })();
  </script>
</body>
</html>
